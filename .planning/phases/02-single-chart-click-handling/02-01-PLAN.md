---
phase: 02-single-chart-click-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - streamlit_app/streamlit_app.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Clicking a scatter point highlights it with larger size and different visual treatment"
    - "Detail panel updates to show participant info (ID, group, intervention phase)"
    - "Detail panel shows solution metrics (ID, result, cost, stress, length, nodes, segments)"
    - "Detail panel shows core attributes (solution type, deck, structure, rock support, materials)"
    - "Solution screenshot loads from GitHub URL with graceful fallback if image fails"
    - "App still displays all 563 solutions correctly when no point is selected"
  artifacts:
    - path: "streamlit_app/streamlit_app.py"
      provides: "Interactive scatter with click handling and detail panel"
      contains: "plotly_events"
    - path: "requirements.txt"
      provides: "Deployment dependencies including streamlit-plotly-events"
      contains: "streamlit-plotly-events"
  key_links:
    - from: "streamlit_app/streamlit_app.py"
      to: "streamlit-plotly-events"
      via: "plotly_events() replaces st.plotly_chart()"
      pattern: "plotly_events\\(fig"
    - from: "streamlit_app/streamlit_app.py"
      to: "st.session_state"
      via: "selected_point_idx persists click across reruns"
      pattern: "session_state\\.selected_point_idx"
    - from: "streamlit_app/streamlit_app.py"
      to: "df.iloc[idx]"
      via: "point index maps to DataFrame row for detail display"
      pattern: "df\\.iloc\\[.*selected"
---

<objective>
Add click-to-inspect interaction to the scatter plot: clicking any point highlights it visually and displays a detail panel with participant info, solution metrics, core attributes, and solution screenshot.

Purpose: This is the core interaction of the visualization tool -- the primary way researchers explore individual solutions in the design space.
Output: Updated streamlit_app.py with click handling and detail panel, updated requirements.txt with streamlit-plotly-events.
</objective>

<execution_context>
@C:/Users/e_par/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/e_par/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-single-chart-click-handling/02-RESEARCH.md
@.planning/phases/01-minimal-streamlit-prototype/01-01-SUMMARY.md
@streamlit_app/streamlit_app.py
@requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add click handling with point highlighting and two-column layout</name>
  <files>streamlit_app/streamlit_app.py, requirements.txt</files>
  <action>
**requirements.txt:** Add `streamlit-plotly-events>=0.0.6` to the deployment dependencies list (after the existing 5 packages).

**streamlit_app/streamlit_app.py:** Restructure the app to support click-to-inspect interaction.

1. Add import: `from streamlit_plotly_events import plotly_events`

2. Initialize session state right after data loading (before any UI):
```python
if 'selected_point_idx' not in st.session_state:
    st.session_state.selected_point_idx = None
```

3. Build per-point marker arrays BEFORE creating the figure. When a point is selected, it should get dramatically different visual treatment matching the original Dash app:
   - Selected point: size=18, symbol='square-x-open', line width=2, line color='black'
   - Unselected points: size=8 (slightly bigger than current 7 for better clickability), original symbol from clust_symb, line width=0, line color from HEX-Win
   - Build these as Python lists using list comprehensions, checking `st.session_state.selected_point_idx`

4. Replace the current `st.plotly_chart(fig, use_container_width=False)` call with a two-column layout:
```python
col_chart, col_detail = st.columns([2, 1])

with col_chart:
    selected_points = plotly_events(
        fig,
        click_event=True,
        select_event=False,
        hover_event=False,
        override_height=700,
        override_width="100%",
    )

    if selected_points:
        clicked_idx = selected_points[0]['pointIndex']
        if clicked_idx != st.session_state.selected_point_idx:
            st.session_state.selected_point_idx = clicked_idx
            st.rerun()
```

5. The detail panel (col_detail) should show a placeholder message when nothing is selected:
```python
with col_detail:
    if st.session_state.selected_point_idx is not None:
        # Detail panel content (Task 2)
        idx = st.session_state.selected_point_idx
        row = df.iloc[idx]
        st.subheader(f"Solution {row['OriginalID_Sol']}")
        st.caption(f"Click a different point to update")
    else:
        st.info("Click a point on the scatter plot to view solution details")
```

Note: The `st.rerun()` call ensures the figure rebuilds with updated marker arrays reflecting the new selection. Without it, the highlight won't appear until the next interaction.

Keep the existing layout configuration (showlegend=False, hovermode='closest', scaleanchor, height=700, margins, colors). The figure height stays at 700. The `override_height=700` in plotly_events should match.
  </action>
  <verify>
Run the app locally: `/c/Users/e_par/miniconda3/condabin/conda.bat run -n DS_312 python -m streamlit run streamlit_app/streamlit_app.py`

Verify:
1. App starts without import errors (streamlit-plotly-events installed)
2. Scatter plot renders with all 563 points
3. Clicking a point triggers a rerun and the clicked point appears larger (size 18) with square-x-open symbol and black border
4. Detail panel area appears to the right of the chart
5. When no point selected, "Click a point..." info message shows
6. When point selected, basic info (solution ID) displays
  </verify>
  <done>
Scatter plot renders with click handling via streamlit-plotly-events; clicking a point highlights it with size=18, square-x-open symbol, and black border; two-column layout shows chart left and detail placeholder right; session state persists selection across reruns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build complete detail panel with participant info, metrics, attributes, and screenshot</name>
  <files>streamlit_app/streamlit_app.py</files>
  <action>
Replace the placeholder detail panel content (from Task 1's `col_detail` block) with the complete detail panel. Reference the original Dash app's layout structure (Divs 9, 10, 11, 12 in interactive_tool.py lines 436-601).

Inside `with col_detail:` when `selected_point_idx is not None`, build these sections using `row = df.iloc[idx]`:

**Section 1: Participant Info** (requirement DETL-01)
Display as three inline items using `st.markdown()`:
- Participant: `row['OriginalID_PT']` (e.g., "P_001")
- Group: `row['OriginalID_Group']` (e.g., "SF")
- Phase: `row['OriginalID_PrePost']` (e.g., "Pre") + " intervention"

Format as a single line: `**Participant:** P_001 | **Group:** SF | **Phase:** Pre intervention`

**Section 2: Solution Header** (requirement DETL-02)
```python
st.subheader(f"Solution {row['OriginalID_Sol']}")
```
Note: OriginalID_Sol is a string like "1.0" -- display as-is (the Dash app shows it as a number next to "Solution_").

**Section 3: Result, Cost, Max Stress** (requirement DETL-03)
Display as a single line:
- Result: `row['result']` (e.g., "win" or "fail")
- Cost: `row['budgetUsed']` formatted with comma separator (e.g., "$15,157")
- Max Stress: `row['maxStress']` formatted to 1 decimal + "%" (e.g., "51.1%")

```python
cost_str = f"${row['budgetUsed']:,}" if isinstance(row['budgetUsed'], (int, float)) else str(row['budgetUsed'])
stress_str = f"{row['maxStress']:.1f}%" if isinstance(row['maxStress'], (int, float)) else str(row['maxStress'])
st.markdown(f"**Result:** {row['result']} | **Cost:** {cost_str} | **Max Stress:** {stress_str}")
```

**Section 4: Length, Nodes, Segments** (requirement DETL-04)
Note: TLength, NSegm, NJoint are stored as strings in the parquet file. Convert TLength to float for formatting; NSegm and NJoint display as-is.
```python
try:
    tlength = f"{float(row['TLength']):.1f}"
except (ValueError, TypeError):
    tlength = str(row['TLength'])
st.markdown(f"**Length:** {tlength}m | **Nodes:** {row['NJoint']} | **Segments:** {row['NSegm']}")
```
IMPORTANT: In the Dash app, NSegm maps to "# nodes" display and NJoint maps to "# segments" display (lines 832-833 of interactive_tool.py: `nodes_id = df_base.loc[clickedSol,'NSegm']` and `segms_id = df_base.loc[clickedSol,'NJoint']`). This naming is counterintuitive but must match the original app exactly.

**Section 5: Divider + Core Attributes header** (requirement DETL-05)
```python
st.divider()
st.markdown("##### Core Attributes")
```

Display each attribute on its own line:
- `**Solution:** {row['ca_sol']}` (e.g., "bridge | 3 anchors")
- `**Deck:** {row['ca_deck']}` (e.g., "fully_connected | shape: inclined platform")
- `**Structure:** {row['ca_str']}` (e.g., "top rock | shape: standard_truss | size: large")
- `**Rock Support:** {row['ca_rck']}` (e.g., "multiple_beams | steel")
- `**Materials:** {row['ca_mtr']}` (e.g., "road wood steel")

**Section 6: Divider + Screenshot** (requirement DETL-06)
```python
st.divider()
image_url = row['videoPreview']
if image_url and str(image_url) != '-' and str(image_url) != 'nan':
    try:
        st.image(image_url, caption=f"Solution {row['OriginalID_Sol']}", use_container_width=True)
    except Exception:
        st.warning("Screenshot unavailable")
else:
    st.info("No screenshot available for this solution")
```
Use `use_container_width=True` so the image fills the detail column width. The URLs are already in raw.githubusercontent.com format (confirmed from data: "https://raw.githubusercontent.com/epz0/bridgespace/main/img/P_001-Pre-1.png").

**Else branch** (no selection):
```python
else:
    st.info("Click a point on the scatter plot to view solution details")
```
  </action>
  <verify>
Run the app locally and click several different points. For each clicked point verify:
1. Participant info line shows correct participant ID, group, and intervention phase
2. Solution header shows the solution number
3. Result/Cost/Stress line shows properly formatted values (comma in cost, % in stress)
4. Length/Nodes/Segments line shows values matching Dash app mapping (NSegm->nodes, NJoint->segments)
5. Core Attributes section shows all 5 attribute fields (solution, deck, structure, rock support, materials)
6. Screenshot loads from GitHub URL and displays in the detail column
7. Clicking a point with no screenshot shows "No screenshot available" fallback
8. When no point is selected, info message is displayed
  </verify>
  <done>
Complete detail panel displays all required information: participant info (DETL-01), solution ID (DETL-02), result/cost/stress (DETL-03), length/nodes/segments (DETL-04), core attributes (DETL-05), and screenshot with fallback (DETL-06). All formatting matches the original Dash app's data mapping.
  </done>
</task>

</tasks>

<verification>
Phase-level verification after both tasks complete:

1. **SCAT-06 (Highlighting):** Click any point -- it should display at size 18 with square-x-open symbol and black border (line width 2). All other points at size 8 with original symbols and no border.

2. **DETL-01 (Participant info):** Click point -- detail panel shows participant ID, group, intervention phase.

3. **DETL-02 (Solution ID):** Click point -- solution number displayed as header.

4. **DETL-03 (Result/Cost/Stress):** Click point -- result (win/fail), cost with $ and commas, max stress with % displayed.

5. **DETL-04 (Length/Nodes/Segments):** Click point -- total length in meters, number of nodes, number of segments displayed.

6. **DETL-05 (Core Attributes):** Click point -- solution type, deck, structure, rock support, materials all displayed.

7. **DETL-06 (Screenshot):** Click point with image -- GitHub screenshot loads. Click point without image -- graceful fallback message.

8. **Regression:** All 563 points still render. Hover text still works. 1:1 aspect ratio maintained.
</verification>

<success_criteria>
- App runs without errors with streamlit-plotly-events installed
- Clicking any of the 563 scatter points highlights it and shows complete detail panel
- Detail panel shows all 6 required information sections (DETL-01 through DETL-06)
- Screenshots load from GitHub raw URLs
- Missing screenshots show fallback message
- Selection persists across reruns via session state
- No point selected state shows helpful info message
</success_criteria>

<output>
After completion, create `.planning/phases/02-single-chart-click-handling/02-01-SUMMARY.md`
</output>
