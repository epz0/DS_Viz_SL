---
phase: 03-filtering-visibility-controls
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - streamlit_app/streamlit_app.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Scatter plot always shows all 563 solutions regardless of participant filter"
    - "Participant filter affects only future arrows/areas (Phase 5)"
    - "Clicking any scatter point works correctly (detail panel shows correct solution)"
    - "Status caption provides accurate feedback about total solutions"
  artifacts:
    - path: "streamlit_app/streamlit_app.py"
      provides: "Scatter trace built from full df, participant filter only used for future features"
      min_lines: 250
      contains: "go.Scatter.*x=df\\['x_emb'\\]"
  key_links:
    - from: "streamlit_app/streamlit_app.py"
      to: "go.Scatter trace"
      via: "uses full df (not df_filtered)"
      pattern: "go\\.Scatter.*x=df\\['x_emb'\\]"
    - from: "streamlit_app/streamlit_app.py"
      to: "click handling"
      via: "maps clicked position to df.index directly"
      pattern: "clicked_original_idx = df\\.index\\.tolist\\(\\)\\[clicked_pos\\]"
---

<objective>
Fix scatter plot to always show all participants. The participant filter should only affect arrows/areas (future Phase 5 features), not the scatter points.

Purpose: User clarified that scatter plot should display all 563 solutions at all times. The participant filter is for controlling arrows and areas visibility, not for filtering scatter points. Current implementation incorrectly filters scatter trace from df_filtered instead of full df.

Output: Scatter plot displays all solutions regardless of participant filter selection. Participant filter becomes a no-op until Phase 5 implements arrows/areas traces.
</objective>

<execution_context>
@C:/Users/e_par/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/e_par/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-filtering-visibility-controls/03-01-SUMMARY.md
@streamlit_app/streamlit_app.py
</context>

<tasks>

<task type="auto">
  <name>Fix scatter trace to always use full df and simplify participant filter logic</name>
  <files>streamlit_app/streamlit_app.py</files>
  <action>
**Root cause:** Lines 99-166 filter df into df_filtered, then build scatter trace from df_filtered. This makes participant filter remove points from scatter plot. User clarified: points should ALWAYS show all 563 solutions. Participant filter is only for arrows/areas (Phase 5).

**Changes required:**

1. **Line 99 (df_filtered computation):** Keep this line but add comment explaining it's for future Phase 5 arrows/areas only
   - Current: `df_filtered = df[df['OriginalID_PT'].isin(selected_participants)]`
   - Add comment: `# df_filtered will be used for arrows/areas in Phase 5, NOT for scatter points`

2. **Lines 102-104 (empty filter guard):** DELETE these lines entirely
   - No need to check if df_filtered is empty since scatter points use full df
   - Chart will never be empty (always shows all 563 solutions)

3. **Lines 106-109 (clear selection when filtered out):** DELETE these lines
   - Selection can never be filtered out since all points are always visible
   - Simplifies state management

4. **Line 82 (show_points checkbox):** DELETE this entire checkbox widget (lines 82-88)
   - Points are always visible (core feature of the app)
   - No need for toggle

5. **Lines 130-166 (scatter trace building):** Change from df_filtered to df
   - Change `for orig_idx, row in df_filtered.iterrows():` to `for orig_idx, row in df.iterrows():`
   - Change `filtered_to_original = df_filtered.index.tolist()` to `original_indices = df.index.tolist()`
   - Change all references to `df_filtered['x_emb']`, `df_filtered['y_emb']`, `df_filtered['hovertxt']`, `df_filtered['HEX-Win']` to use `df` instead
   - Update customdata to `original_indices`

6. **Lines 148-169 (conditional scatter rendering):** DELETE the if/else show_points conditional
   - Remove `if show_points:` wrapper (lines 149-166)
   - Remove the else block with st.info message (lines 167-169)
   - Scatter trace should ALWAYS render (no conditional)

7. **Lines 197-203 (click handling):** Simplify click mapping
   - Current: maps `clicked_filtered_pos` to `filtered_to_original[clicked_filtered_pos]`
   - Change to: `clicked_original_idx = original_indices[clicked_filtered_pos]`
   - Remove the `if show_points and` condition from line 197 (points are always visible)

8. **Lines 206-209 (status caption):** Simplify to just show total solutions
   - Remove the dynamic filter status since participant filter no longer affects scatter plot
   - Change to: `st.caption(f"Showing {len(df):,} solutions from {len(all_participants)} participants")`
   - Or simpler: `st.caption(f"{len(df):,} total solutions")`

**What NOT to change:**
- Keep the participant multiselect dropdown (lines 70-77) — it will be used in Phase 5 for arrows/areas
- Keep df_filtered computation (line 99) — will be used in Phase 5 for arrows/areas filtering
- Keep show_arrows and show_areas checkboxes (lines 84-96) — Phase 5 placeholders
- Keep all existing click handling logic for detail panel display
- Keep all existing detail panel rendering (lines 211+)

**Expected outcome:**
- Scatter plot displays all 563 solutions regardless of participant filter
- Participant filter dropdown still exists but has no visible effect (until Phase 5)
- Click handling works correctly (simpler now — no filtered_to_original mapping needed)
- Status caption shows total solution count
- No empty filter warnings or point hiding
  </action>
  <verify>
Run the Streamlit app and test:
```bash
cd c:/Py/DS_Viz_SL
/c/Users/e_par/miniconda3/condabin/conda.bat run -n DS_312 streamlit run streamlit_app/streamlit_app.py
```

Manual verification:
1. App loads with scatter plot showing all 563 solutions
2. Deselect some participants in sidebar filter → scatter plot UNCHANGED (all 563 points still visible)
3. Click any scatter point → detail panel shows correct solution
4. Deselect all participants → scatter plot UNCHANGED (all 563 points still visible), no error/warning
5. Status caption shows total solution count (not filtered count)
6. Points checkbox no longer exists in sidebar
  </verify>
  <done>
- Scatter trace built from `df` (not `df_filtered`) — grep confirms `go.Scatter(x=df['x_emb']` pattern
- show_points checkbox removed from sidebar
- Empty filter guard removed (no st.stop() after df_filtered computation)
- Clear selection logic removed (no check for filtered out points)
- Click handling simplified (uses original_indices directly, no filtered_to_original mapping)
- Status caption shows total count (not dynamic filter state)
- App displays all 563 solutions regardless of participant filter selection
- Clicking any point shows correct solution in detail panel
  </done>
</task>

</tasks>

<verification>
**Behavioral verification:**
1. Launch app: `streamlit run streamlit_app/streamlit_app.py`
2. Scatter plot displays all 563 solutions on load (31 participants, all selected by default)
3. Deselect participants in sidebar → scatter plot unchanged (all points remain)
4. Click any scatter point → detail panel updates with correct solution
5. Status caption shows total solution count

**Code verification:**
```bash
# Confirm scatter trace uses full df
grep -n "go.Scatter" streamlit_app/streamlit_app.py | grep "df\['x_emb'\]"

# Confirm no show_points checkbox
grep -n "show_points" streamlit_app/streamlit_app.py | wc -l  # Should be 0

# Confirm no empty filter guard
grep -n "df_filtered.empty" streamlit_app/streamlit_app.py | wc -l  # Should be 0

# Confirm simplified click handling
grep -n "original_indices\[clicked" streamlit_app/streamlit_app.py
```
</verification>

<success_criteria>
- [ ] Scatter plot displays all 563 solutions on first load
- [ ] Participant filter selection has NO effect on scatter plot points
- [ ] Clicking any scatter point highlights it correctly
- [ ] Detail panel shows correct solution data for clicked point
- [ ] No show_points checkbox in sidebar
- [ ] No empty filter warnings or st.stop() guards
- [ ] Status caption shows total solution count (not filtered count)
- [ ] Code uses `df` for scatter trace, not `df_filtered`
</success_criteria>

<output>
After completion, create `.planning/phases/03-filtering-visibility-controls/03-02-SUMMARY.md`

Document:
- Gap addressed: Scatter trace now uses full df, participant filter only affects future arrows/areas
- Lines changed: Removed show_points checkbox, empty filter guard, selection clearing logic, conditional scatter rendering
- Click handling simplified: No filtered_to_original mapping needed
- Status caption simplified: Shows total solutions, not filtered count
- User clarification: Points always visible, participant filter for Phase 5 arrows/areas only
</output>
