---
phase: 01-minimal-streamlit-prototype
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - streamlit_app/streamlit_app.py
  - requirements.txt
  - requirements-dev.txt
  - .streamlit/config.toml
  - .gitignore
autonomous: false

must_haves:
  truths:
    - "Streamlit app displays scatter plot with all 563 solutions colored by participant"
    - "Hover text on each point shows participant ID, solution number, pre/post, and result"
    - "Marker symbols differ by cluster assignment matching original Dash app"
    - "Data loads from cached parquet/json files using @st.cache_data"
    - "requirements.txt contains only 5 slim packages (streamlit, plotly, pandas, numpy, shapely)"
  artifacts:
    - path: "streamlit_app/streamlit_app.py"
      provides: "Main Streamlit app with cached data loading and scatter plot"
      min_lines: 60
    - path: "requirements.txt"
      provides: "Slim deployment dependencies"
      contains: "streamlit"
    - path: ".streamlit/config.toml"
      provides: "Streamlit theme and layout configuration"
      contains: "theme"
  key_links:
    - from: "streamlit_app/streamlit_app.py"
      to: "streamlit_app/data/df_base.parquet"
      via: "pd.read_parquet with @st.cache_data"
      pattern: "read_parquet.*df_base"
    - from: "streamlit_app/streamlit_app.py"
      to: "streamlit_app/data/metadata.json"
      via: "json.load with @st.cache_data"
      pattern: "metadata\\.json"
    - from: "streamlit_app/streamlit_app.py"
      to: "plotly.graph_objects.Scatter"
      via: "go.Scatter with HEX-Win colors and clust_symb symbols"
      pattern: "go\\.Scatter"
---

<objective>
Create the minimal Streamlit app that loads Phase 0 pre-computed data and displays a static scatter plot of all design solutions, with deployment-ready configuration.

Purpose: Prove the Streamlit deployment path works -- app loads data fast, displays the scatter plot correctly with proper colors/symbols/hover, and stays within Community Cloud's slim dependency budget.

Output: Working Streamlit app runnable locally with `streamlit run streamlit_app/streamlit_app.py`, slim requirements.txt, and Streamlit config.
</objective>

<execution_context>
@C:/Users/e_par/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/e_par/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-minimal-streamlit-prototype/01-RESEARCH.md
@.planning/phases/00-data-preparation/00-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Streamlit app with cached data loading and scatter plot</name>
  <files>streamlit_app/streamlit_app.py</files>
  <action>
Create streamlit_app/streamlit_app.py as the main Streamlit entry point. The app structure must follow this exact order:

1. **Imports:** streamlit, pandas, plotly.graph_objects, json, pathlib

2. **Page config (MUST be first Streamlit command):**
   st.set_page_config(page_title="Design Space Visualization", layout="wide", initial_sidebar_state="auto")

3. **Data loading functions with @st.cache_data:**
   - load_solutions(): reads df_base.parquet from DATA_DIR (Path(__file__).parent / 'data')
   - load_metadata(): reads metadata.json from DATA_DIR
   Both decorated with @st.cache_data for cross-session caching.
   Do NOT load convex_hulls.pkl -- not needed for Phase 1 (deferred to Phase 5).

4. **Main app body:**
   - st.title("Design Space Visualization")
   - Load data: df = load_solutions(), metadata = load_metadata()
   - Brief status: st.caption showing solution count and participant count

5. **Scatter plot using plotly.graph_objects (NOT px.scatter):**
   The original Dash app uses go.Scatter with per-point color/symbol arrays, NOT px.scatter with categorical mapping. This is critical because:
   - 31 participants would create an unreadable legend with px.scatter
   - The original app has showlegend=False
   - Per-point HEX-Win colors already encode participant identity
   - Per-point clust_symb already maps cluster to symbol names

   Build the scatter plot:
   ```python
   fig = go.Figure()
   fig.add_trace(go.Scatter(
       x=df['x_emb'],
       y=df['y_emb'],
       mode='markers',
       hovertemplate=df['hovertxt'].tolist(),
       marker=dict(
           size=7,
           color=df['HEX-Win'].tolist(),
           symbol=df['clust_symb'].tolist(),
           line=dict(color=df['HEX-Win'].tolist()),
       ),
       name='',
   ))
   ```

   The hovertxt column already contains pre-formatted HTML hover text like:
   `<b>P_001 | Sol. 1</b><br>Pre | win`
   This satisfies SCAT-05 (hover shows participant ID, solution number, pre/post, result).

   Layout updates:
   ```python
   fig.update_layout(
       showlegend=False,
       hovermode='closest',
       xaxis=dict(title='UMAP Dimension 1'),
       yaxis=dict(title='UMAP Dimension 2'),
       margin=dict(l=40, r=40, b=40, t=40, pad=2),
       plot_bgcolor='white',
       paper_bgcolor='rgba(0,0,0,0)',
   )
   ```

6. **Display the chart:**
   st.plotly_chart(fig, use_container_width=True)

Important constraints:
- Do NOT import anything from scripts/ or scripts/design_space/ (would pull heavy deps)
- Do NOT use px.scatter (creates unwanted 31-entry legend, different from original)
- Do NOT load convex_hulls.pkl (Phase 5 feature)
- Do NOT add streamlit-plotly-events (Phase 2 feature)
- Keep the file focused and minimal -- this is the foundation that later phases extend
  </action>
  <verify>
Run: /c/Users/e_par/miniconda3/condabin/conda.bat run -n DS_312 python -c "import ast; ast.parse(open('streamlit_app/streamlit_app.py').read()); print('Syntax OK')"
Verify file contains: st.set_page_config as first Streamlit call, @st.cache_data decorators, go.Scatter (not px.scatter), read_parquet, metadata.json load, hovertxt in hovertemplate, showlegend=False
  </verify>
  <done>
streamlit_app/streamlit_app.py exists, parses without errors, loads df_base.parquet and metadata.json with @st.cache_data, creates go.Scatter plot with per-point HEX-Win colors, clust_symb symbols, and hovertxt hover text
  </done>
</task>

<task type="auto">
  <name>Task 2: Create deployment requirements and Streamlit config</name>
  <files>requirements.txt, requirements-dev.txt, .streamlit/config.toml, .gitignore</files>
  <action>
**requirements.txt** -- Replace the current bloated requirements.txt (81 lines, includes dash, umap-learn, scikit-learn, etc.) with a slim deployment file:

```
# Streamlit app deployment dependencies
# Target: ~150-200MB total installed size
streamlit>=1.30.0
plotly>=5.23.0
pandas>=2.2.0
numpy>=2.0.0
shapely>=2.0.0
```

Only 5 packages. This is all the deployed Streamlit app needs. The heavy pipeline deps (umap-learn, scikit-learn, scipy, igraph, etc.) stay in requirements-dev.txt which already has `-r requirements.txt`.

IMPORTANT: The current requirements.txt is the OLD Heroku/Dash deployment file. It MUST be replaced, not appended to. The old file has dash, gunicorn, numba, llvmlite, scikit-learn, etc. -- none of these are needed for the Streamlit app.

Also update requirements-dev.txt to list the pipeline deps explicitly (since they're no longer in requirements.txt):

Read the current requirements-dev.txt first. It currently says `-r requirements.txt` plus pyarrow. It needs to be updated to explicitly list all the heavy deps that were removed from requirements.txt, so the local pipeline still works. Add these packages (from the old requirements.txt that are needed by scripts/precompute.py and scripts/design_space/):

```
# Development/pipeline dependencies
# Includes production (Streamlit) dependencies
-r requirements.txt

# Pre-computation pipeline (Phase 0)
umap-learn>=0.5.7
scikit-learn>=1.5.2
scipy>=1.14.1
igraph>=0.11.8
gower>=0.1.2
openpyxl>=3.1.5
numba>=0.60.0
pyarrow>=14.0.0

# Existing analysis scripts
dash>=2.18.0
matplotlib>=3.9.0
seaborn>=0.13.0
statsmodels>=0.14.0
gunicorn>=23.0.0
```

**.streamlit/config.toml** -- Create Streamlit configuration (DEPL-05):

```toml
[theme]
primaryColor = "#0343df"
backgroundColor = "#ffffff"
secondaryBackgroundColor = "#f0f2f6"
textColor = "#262730"

[server]
headless = true

[browser]
gatherUsageStats = false
```

**.gitignore** -- The current .gitignore blocks .gitignore itself (which is odd) and has some patterns commented out. Update it to:
- Keep existing ignores (*.pyc, *.png, *.html, *.svg, *.emf, /validation, /viz)
- Remove the `.gitignore` entry (it should not ignore itself)
- Add `venv/` (project has a venv directory that shouldn't be committed)
- Add `__pycache__/`
- Add `streamlit_app/data/intermediate/` (intermediate pipeline files don't need to be in the deployed app -- though they're already committed, this prevents future additions)
- Keep NOT ignoring streamlit_app/data/*.parquet, *.pkl, *.json (these MUST be committed for Community Cloud)
  </action>
  <verify>
Run: cat requirements.txt (should show 5 packages, no dash/umap/scikit-learn)
Run: cat .streamlit/config.toml (should show theme and server config)
Run: cat .gitignore (should not contain .gitignore entry, should have venv/ and __pycache__/)
Run: cat requirements-dev.txt (should have -r requirements.txt and all pipeline deps)
  </verify>
  <done>
requirements.txt has exactly 5 slim packages, .streamlit/config.toml configures theme and headless server, .gitignore is cleaned up, requirements-dev.txt lists all pipeline dependencies explicitly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Streamlit app runs locally with correct scatter plot</name>
  <action>
User visually verifies the Streamlit app displays correctly in the browser. Claude starts the app with: /c/Users/e_par/miniconda3/condabin/conda.bat run -n DS_312 streamlit run streamlit_app/streamlit_app.py
  </action>
  <what-built>
Complete Streamlit app with scatter plot, slim deployment config, and Streamlit theme. The app loads 563 solutions from pre-computed parquet data and displays them as an interactive scatter plot with per-participant colors and per-cluster symbols.
  </what-built>
  <how-to-verify>
1. Start the app locally:
   Open a terminal in C:/Py/DS_Viz_SL and run:
   conda activate DS_312
   streamlit run streamlit_app/streamlit_app.py

2. Verify the scatter plot:
   - All 563 points visible with different colors per participant
   - Different marker symbols for different clusters
   - Hover over points to see: participant ID, solution number, pre/post, result
   - Plot uses full width of the page (wide layout)

3. Verify the page:
   - Title shows "Design Space Visualization"
   - Caption shows solution and participant counts
   - No errors in the terminal output

4. Check data loading speed:
   - First load should be under 2 seconds
   - Refresh the page (Ctrl+R) -- second load should be near-instant (cached)
  </how-to-verify>
  <verify>User confirms app displays correctly</verify>
  <done>User approves the scatter plot appearance, hover text, and page layout</done>
  <resume-signal>Type "approved" or describe any visual/functional issues</resume-signal>
</task>

</tasks>

<verification>
- streamlit_app/streamlit_app.py parses without syntax errors
- requirements.txt contains only 5 packages (no heavy deps)
- .streamlit/config.toml exists with theme configuration
- App loads df_base.parquet and metadata.json via @st.cache_data
- Scatter plot uses go.Scatter with per-point colors from HEX-Win column
- Hover text shows participant ID, solution number, pre/post, result (from hovertxt column)
- No imports from scripts/ directory
</verification>

<success_criteria>
- Streamlit app runs locally with `streamlit run streamlit_app/streamlit_app.py`
- Scatter plot shows all 563 solutions with correct participant colors and cluster symbols
- Hover on any point shows formatted text (e.g., "P_001 | Sol. 1 / Pre | win")
- Data loads from cache in under 2 seconds
- requirements.txt has only streamlit, plotly, pandas, numpy, shapely (~150-200MB deployed)
- .streamlit/config.toml configures theme and layout
</success_criteria>

<output>
After completion, create `.planning/phases/01-minimal-streamlit-prototype/01-01-SUMMARY.md`
</output>
